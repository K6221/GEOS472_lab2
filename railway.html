<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Railway Network in Osaka Prefecture</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js'></script>
  <link href='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css' rel='stylesheet'>

  <style>
    body { margin: 0; padding: 0; }
    #map { position:absolute; top: 0; bottom:0; width: 100% }

  </style>
  
</head>
<body>
  <style>
    .style-selector {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 1
    }

    .clear-button {
      position: absolute;
      top: 10px;
      left: 10px;
      background-color: white;
      padding: 10px;
    }
    
  </style>
  <div id="map"></div>
  
  <div class="style-selector">
        <input id="dark-basemap" type="radio" name="rtoggle" value="cltxr4dy101ix01r5elg32b1a" checked="checked">
        <label for="dark-basemap">Dark basemap</label>
        <input id="light-basemap" type="radio" name="rtoggle" value="clu3253js025s01ra1ktn14qc">
        <label for="light-basemap">Light basemap</label>
  </div>

  <div>
    <button onclick="clearMap()" class="clear-button">Clear</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    
    // add base map 
    mapboxgl.accessToken = 'pk.eyJ1IjoiazYyMjEiLCJhIjoiY2xzc2VyczZiMTJnMTJsbnlqYmY0eDBidCJ9.qYmhavVJJbDDzeyoAuTXeQ';

    var map = new mapboxgl.Map({
            container: 'map', 
            style: 'mapbox://styles/k6221/cltxr4dy101ix01r5elg32b1a',
            center: [135.5075, 34.5986], // set Osaka, Japan as the centre
            zoom: 9.3
        });

    // clear Map highlight function (makes it default)
    function clearMap(style) {
      if (style === 'mapbox://styles/k6221/clu3253js025s01ra1ktn14qc') { // Light basemap
        map.setPaintProperty('stations', 'circle-stroke-color', 'black');
        map.setPaintProperty('lines', 'line-color', ['get', 'colour']);
      } else { // close if: Dark basemap
        map.setPaintProperty('stations', 'circle-stroke-color', 'white');
        map.setPaintProperty('lines', 'line-color', ['get', 'colour']);
      } // close else
    } // close clearMap
        
        


    function addLayersAfterStyleLoad() {
    // load line GeoJSON
    fetch("https://raw.githubusercontent.com/K6221/GEOS472_lab2/main/line.geojson").then(res => res.json()).then(linedata => {
        map.addSource('lines', {
          type: 'geojson',
          data: linedata
        });
        // add to the map 
        map.addLayer({
          'id': 'lines',
          'type': 'line',
          'source': 'lines',
          'paint': {
            'line-color': ['get', 'colour'], // set a colour based on hex code in geojson file
            'line-opacity': [
              'match',
              ['get', 'dominant type'],
              'Underground', 0.3, // if the dominant type is "Underground," make it less opaque
              'Ground', 1, 
              'Elevated', 1,
              1 // set default for other classes just in case
            ],
            'line-width': 4,
          }
        }); // close map.addLayer
    }); // close fetch line
    
    //load station GeoJSON 
    fetch("https://raw.githubusercontent.com/K6221/GEOS472_lab2/main/station.geojson").then(res => res.json()).then(stationdata => {
        map.addSource('stations', {
          type: 'geojson',
          data: stationdata
        }); // close map.addSource
        
        map.addLayer({
          'id': 'stations',
          'type': 'circle',
          'source': 'stations',
          'paint': {
            'circle-radius': 6,
            'circle-color': 'white',
            'circle-opacity': 0,
            'circle-stroke-color': 'white',
            'circle-stroke-width': 2
          } //close paint
        }); // close map.addLayer

        // highlight function
        function highlightStationsOnLine(lineName, style) {
          if (style === 'mapbox://styles/k6221/clu3253js025s01ra1ktn14qc') {// Light basemap selected
            map.setPaintProperty('stations', 'circle-stroke-color', ['case',
                                                                     ['==', ['get', 'Line'], lineName], // Red for clicked station
                                                                     'red', 
                                                                     'black' 
                                                                     ]);
          } else {// Dark basemap selected
            map.setPaintProperty('stations', 'circle-stroke-color', ['case',
                                                                     ['==', ['get', 'Line'], lineName], // Yellow for clicked station
                                                                     'yellow', 
                                                                     'white'
                                                                     ]);
          } // close else
        }// close highlightStationsOnLine function

        map.on('click', 'stations', (e) => {
          // remove previous highlights (make it default)
          clearMap(map.getStyle().layers[0].id); 

          const features = map.queryRenderedFeatures(e.point, { layers: ['stations'] });
          if (features.length > 0) {
            const station = features[0];
            const lineName = station.properties.Line;
            const style = map.getStyle().layers[0].id;
            highlightStationsOnLine(lineName, style);
          } else {
            clearMap(map.getStyle().layers[0].id);
          } // close else

          // add popup
          new mapboxgl.Popup()
            .setLngLat(e.lngLat)
            .setHTML(
              `<P> ${e.features[0].properties.StationName} Station</p>
               <p><strong>Station Number:<strong> ${e.features[0].properties.StationNumber}</p>
               <p><strong>Line:</strong> ${e.features[0].properties.Line}</p>
               <p><strong>Station Type</strong> ${e.features[0].properties.Type}</p>
               <p><strong>Japanese Name:</strong> ${e.features[0].properties.JPname}</p>`
            ) // cloase setHTML
            .addTo(map);
        }); // close map.on click function

        //change the cursor to a pointer when the mouse is over the station points
        map.on('mouseenter', 'stations', () => {
          map.getCanvas().style.cursor = 'pointer';
        });

        // change the cursor back to a pointer when it leaves the station points
        map.on('mouseleave', 'stations', () => {
          map.getCanvas().style.cursor = '';
        });
        
      }); // close map.on
    }; // close fetch station

    map.on('style.load', () => {
      addLayersAfterStyleLoad();
    }); // close map.on style.load

    const styleSelector = document.getElementsByClassName('style-selector')[0];
    const inputs = styleSelector.getElementsByTagName('input');
    
    for (const input of inputs) {
      input.onclick = () => {
        const layerId = input.value;
        map.setStyle(`mapbox://styles/k6221/${layerId}`);
      }; // close input.onclick
    } // close for loop

  </script>
</body>
</html>
